
-- Dynamic Malware Analysis Steps --

· Preparing
· Analyzing
· Process Activities
· Network Activities
· Registry Activities
· File Activities
· Result
· Artifacts

File Name: Sales Order Sheet.pdf.exe
MD5 Hash: 411019bcb582ef6e3dab080d99925b4b
SHA256 Hash: f381e338212079c3a03fbbb532cdec44b1d27db03e8cc4c47408ef038885d934


-- Preparing --

Because our monitoring tools list all the activities that have been done since the time the malware was run, we should run these tools before executing the suspicious program we have. Let's run the  'Process Hacker' to see the process activities.

To see the file activities, run the tool called “Procmon” in the SysInternals toolkit. This tool allows us to see process, file, registry and network activities. 

Run RegShot to see registry activities. Take a shot by pressing the “1st shot” button before running the malware

Open the Wireshark application to see network activities


-- Analyze --

Now that we have completed the necessary preparations before running the malware, you can run the malware on your VM. 

For a better understanding, we will examine the process, network, registry and file activities separately. After reviewing these activities, we will create a timeline.

After allowing enough time for the malware to perform its activity, let's take the second shot by pressing the "2nd shot" button from the Regshot tool


-- Process Activities --

When we examine the running processes using Process Hacker, we see that only 1 process belonging to the malware is running.

The malware may have created a different process, but we may not be able to see it because it is not running instantly. Let's confirm this behavior using the procmon tool. If you press the "Show Process Tree" button in the top menu, procmon will show the process tree it has created for you during the time it has recorded.

As we can see in the image above, we see that the first process we run (8780 PID) has a child process (7100 PID) named "regsvcs.exe".

Regsvcs.exe is a tool called .NET Service Installation Utility, which is installed by default in Windows operating systems by Microsoft.

Attackers often name applications that come by default in the operating system to avoid detection. We have to determine whether the malware we are examining is really the legitimate application that comes by default in Windows or it is how the attacker named his own software to prevent detection

When we examine the path information of the process, we see that the actual directory where the RegSvcs.exe tool, which comes by default in the Windows operating system appears.

Let's get the hash of "C:\Windows\[Microsoft.NET](http://microsoft.net/)\Framework\v4.0.30319\RegSvcs.exe" with the help of the tool named HashMyFile.

Search the hash on VirusTotal

We have determined that the running application is indeed an application published by Microsoft. So does this mean the app is safe?

Attackers can inject malicious code into legitimate applications by using techniques such as Code Injection, Process Hollowing, Reflective DLL Injection that allow these applications to run the malicious codes. In addition, there are binaries that are called "living of the land binary" and that allow malicious activities to be carried out without injecting malicious code.

We can assume that our malware creates this process to perform a malicious activity since it’s created by malware. However, we must always support our assumptions with valid evidence. The next time when we examine network, registry activities, we will prove that this process is indeed used for malicious purposes.

We detected malware processes (8780, 7100 PIDs) with the help of Procmon. Next, we need to detect the network, file and registry activities of these processes.

You can filter down processes with PID values of 8780, 7100 on Procmon. However, there is an easier method. When you right-click on the top parent process of the malware and press the "**Add process and children to Include filter**" button, procmon will create these filters for you.


-- Network Activities --

Before performing our analysis on Wireshark, let's check to see if the malware makes any web requests, as it can be examined more easily.

When we look at the Fiddler application, we see that there is a web request made by the malware (regsvcs.exe, 7100 PID).

When we examine the web request, we see that the malware makes a request to [checkip.dyndns.org](http://checkip.dyndns.org/) in order to find the public IP address. Attackers often use IP address learning services to perform targeted attacks or learn the victim's IP address. This behavior may be considered commonplace for malware.

Did you notice the name of the process making the web request? "Regsvcs.exe" should not throw such a request in normal use.

When we examine the network activities over Wireshark, we see that there is SMTP traffic. SMTP is the protocol used for sending email. Since we didn’t send email, we can say that this is a very suspicious traffic.

If we examine the SMTP traffic, we find that the malware connects to skychine[.]com[.]my's mail server and sends email to graceunlimited153@gmail[.]com with "Pc Name: admin | Snake Keylogger"

When we look at the content of the mail, we see that there are multiple attachments with names such as "Password.txt", "User.txt". In order to bring the contents to readable format, we have to base64 decoding.

As you can see from the subject title and email content, the malware we analyzed is actually Snake Keylogger.

When we look at the e-mail content, we can see that the malware sends the user name, password information of the web applications and the IP address of the device.

Attackers often send the information they have obtained to their own email addresses using SMTP servers that they have previously seized. In other words, the skychine[.]com[.]my domain name is actually an SMTP server that is not malicious but is hijacked by the attacker and used for malicious purposes. However, since the email sent was sent to the attacker's email address, the [graceunlimited153@gmail.com](mailto:graceunlimited153@gmail.com) address most likely belongs to the attacker.


-- Result --

Now that we have completed the malware analysis, we can combine the information we have gathered. We have detected that:

- It’s Snake Keylogger
- Steals credentials from browsers
- Checks IP address
- Exfiltrates data via SMTP
- Connects skyshine.com[.]my:25


-- Artifacts --

- MD5: 411019bcb582ef6e3dab080d99925b4b
- SHA256: f381e338212079c3a03fbbb532cdec44b1d27db03e8cc4c47408ef038885d934
- File Name: Sales Order Sheet.pdf.exe
- Domain: checkip.dyndns.org
- Domain: skyshine[.]com[.]my


